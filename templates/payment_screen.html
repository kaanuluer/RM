{% extends "layout.html" %}

{% block content %}
<style>
    .item-row.selected { background-color: #d1ecf1 !important; border-left: 5px solid #0c5460; }
    .item-row.paid { background-color: #e2e3e5; opacity: 0.6; pointer-events: none; }
</style>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Payment for Order #{{ order.id }}</h2>
        <div>
            <a href="{{ url_for('print_bill', order_id=order.id) }}" target="_blank" class="btn btn-outline-info">Print Customer Bill</a>
        
        {% if remaining_balance < 0.01 %}
        <!-- ... (Close Order butonu burada kalacak) ... -->
        {% endif %}
 
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <h4>Unpaid Items</h4>
            <div class="btn-group mb-2" role="group">
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllItems()">Select All</button>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearSelection()">Clear Selection</button>
            </div>
            <div class="btn-group mb-2" role="group">
                {% for seat in order.seats %}<button type="button" class="btn btn-sm btn-outline-info" onclick="selectBySeat({{ seat.id }})">Seat {{ seat.seat_number }}</button>{% endfor %}
            </div>

            <div class="list-group mb-4">
                {% for item in unpaid_items %}
                <div class="list-group-item item-row" id="item-row-{{ item.id }}" data-item-id="{{ item.id }}" onclick="toggleItem(this)">
                    <div class="d-flex w-100 justify-content-between">
                        <h5 class="mb-1">{{ item.menu_item.name }} (x{{ item.quantity }})</h5>
                        <strong>${{ "%.2f"|format(item.price_at_time_of_order) }}</strong>
                    </div>
                    <p class="mb-1">Seat {{ item.seat.seat_number }}</p>
                </div>
                {% endfor %}
            </div>

            <h4 class="mt-4">Paid Items</h4>
            <div class="list-group">
                {% for payment in order.payments %}{% for item in payment.paid_items %}
                    <div class="list-group-item item-row paid">
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1">{{ item.menu_item.name }} (x{{ item.quantity }})</h5>
                            <strong>${{ "%.2f"|format(item.price_at_time_of_order) }}</strong>
                        </div>
                        <p class="mb-1">Paid via {{ payment.payment_method }}</p>
                    </div>
                {% endfor %}{% endfor %}
            </div>
        </div>

        <div class="col-md-4">
            <div class="card sticky-top">
                <div class="card-body">
                    <h4 class="card-title">Current Payment</h4><hr>
                    <p><strong>Subtotal:</strong><span class="float-end" id="subtotal-display">$0.00</span></p>
                    <p><strong>Tax ({{ (order.tax_rate * 100)|int }}%):</strong><span class="float-end" id="tax-display">$0.00</span></p>
                    <h5 class="mt-2"><strong>Total for Selected:</strong><span class="float-end" id="total-display">$0.00</span></h5><hr>

                    <form id="payment-form" method="POST" action="{{ url_for('process_transaction', order_id=order.id) }}">
                        <div id="selected-items-inputs"></div>
                        <div class="mb-3">
                            <label for="payment_method" class="form-label">Payment Method</label>
                            <select name="payment_method" id="payment_method" class="form-select" required><option value="Cash">Cash</option><option value="Debit">Debit</option><option value="Visa">Visa</option></select>
                        </div>
                        <div class="mb-3">
                            <label for="amount_paid" class="form-label">Amount Tendered</label>
                            <input type="number" step="0.01" class="form-control" name="amount_paid" id="amount_paid" required>
                        </div>
                        <div class="d-grid"><button type="submit" class="btn btn-success" id="pay-button" disabled>Pay for Selected</button></div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const unpaidItemsData = { {% for item in unpaid_items %}"{{ item.id }}": { price: {{ item.price_at_time_of_order }}, quantity: {{ item.quantity }}, seat: {{ item.seat.id }} },{% endfor %} };
    const taxRate = {{ order.tax_rate }};
    let selectedItemIds = new Set();

    const subtotalEl = document.getElementById('subtotal-display');
    const taxEl = document.getElementById('tax-display');
    const totalEl = document.getElementById('total-display');
    const amountPaidEl = document.getElementById('amount_paid');
    const payButtonEl = document.getElementById('pay-button');
    const formInputsContainer = document.getElementById('selected-items-inputs');

    function toggleItem(element) {
        const itemId = element.dataset.itemId;
        if (selectedItemIds.has(itemId)) { selectedItemIds.delete(itemId); element.classList.remove('selected'); } 
        else { selectedItemIds.add(itemId); element.classList.add('selected'); }
        updateTotals();
    }

    function selectAllItems() {
        document.querySelectorAll('.item-row:not(.paid)').forEach(el => {
            selectedItemIds.add(el.dataset.itemId); el.classList.add('selected');
        });
        updateTotals();
    }

    function selectBySeat(seatId) {
        clearSelection();
        for (const [id, data] of Object.entries(unpaidItemsData)) {
            if (data.seat === seatId) {
                selectedItemIds.add(id); document.getElementById(`item-row-${id}`).classList.add('selected');
            }
        }
        updateTotals();
    }

    function clearSelection() {
        selectedItemIds.clear();
        document.querySelectorAll('.item-row.selected').forEach(el => el.classList.remove('selected'));
        updateTotals();
    }

    function updateTotals() {
        let subtotal = 0;
        formInputsContainer.innerHTML = '';
        selectedItemIds.forEach(id => {
            const item = unpaidItemsData[id];
            subtotal += item.price * item.quantity;
            const input = document.createElement('input');
            input.type = 'hidden'; input.name = 'item_ids[]'; input.value = id;
            formInputsContainer.appendChild(input);
        });
        const tax = subtotal * taxRate;
        const total = subtotal + tax;
        subtotalEl.textContent = `$${subtotal.toFixed(2)}`;
        taxEl.textContent = `$${tax.toFixed(2)}`;
        totalEl.textContent = `$${total.toFixed(2)}`;
        amountPaidEl.value = total.toFixed(2);
        payButtonEl.disabled = selectedItemIds.size === 0;
    }
</script>
{% endblock %}